services:
  # ==================== DATABASES ====================

  postgres:
    image: postgres:15-alpine
    container_name: job-portal-postgres
    environment:
      POSTGRES_USER: job_portal_user
      POSTGRES_PASSWORD: devan
      POSTGRES_DB: job_portal
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U job_portal_user -d job_portal"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  redis:
    image: redis:7-alpine
    container_name: job-portal-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - backend

  # ==================== ADMIN TOOLS ====================

  pgadmin:
    image: dpage/pgadmin4:7
    container_name: pgadmin
    restart: always
    ports:
      - "8080:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    depends_on:
      - postgres
    networks:
      - backend

  # ==================== OBSERVABILITY ====================

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    networks:
      - backend

  grafana:
    image: grafana/grafana:10.0.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    depends_on:
      - prometheus
    networks:
      - backend

  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    networks:
      - backend

  # ==================== MESSAGING ====================

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: job-portal-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"
    networks:
      - backend

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: job-portal-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - backend

  # ==================== BACKEND SERVICES ====================

  user-service:
    container_name: user-service
    build: ./user-service
    env_file:
      - .env
      - ./user-service/.env.docker
    environment:
      - DATABASE_URL=postgresql://user_service_user:user_pass@postgres:5432/user_service_db
  company-service:
    container_name: company-service
    build: ./company-service
    env_file:
      - .env
      - ./company-service/.env.docker
    environment:
      - DATABASE_URL=postgresql://company_service_user:company_pass@postgres:5432/company_service_db
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - backend

  job-service:
    container_name: job-service
    build: ./job-service
    env_file:
      - .env
      - ./job-service/.env.docker
    environment:
      - DATABASE_URL=postgresql://job_service_user:job_pass@postgres:5432/job_service_db
    ports:
      - "3002:3002"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend

  subscription-service:
    container_name: subscription-service
    build: ./subscription-service
    env_file:
      - .env
      - ./subscription-service/.env.docker
    environment:
      - DATABASE_URL=postgresql://subscription_service_user:subscription_pass@postgres:5432/subscription_service_db
    ports:
      - "3005:3005"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - backend

  application-service:
    container_name: application-service
    build: ./application-service
    env_file:
      - .env
      - ./application-service/.env.docker
    environment:
      - DATABASE_URL=postgresql://application_service_user:application_pass@postgres:5432/application_service_db
    ports:
      - "3004:3004"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - backend

  notification-service:
    container_name: notification-service
    build: ./notification-service
    env_file:
      - .env
      - ./notification-service/.env.docker
    environment:
      - MONGODB_URI=mongodb+srv://devanrejikumar007_db_user:devan@cluster0.r3yinx6.mongodb.net/notification_db?retryWrites=true&w=majority
      - KAFKA_BROKERS=kafka:29092
    ports:
      - "4005:4005"
    depends_on:
      kafka:
        condition: service_started
    networks:
      - backend

  chat-service:
    container_name: chat-service
    build: ./chat-service
    env_file:
      - .env
      - ./chat-service/.env.docker
    environment:
      - MONGODB_URI=mongodb+srv://devanrejikumar007_db_user:devan@cluster0.r3yinx6.mongodb.net/
    ports:
      - "4007:4007"
    depends_on:
      kafka:
        condition: service_started
    networks:
      - backend

  api-gateway:
    container_name: api-gateway
    build: ./customAPI-gateway
    env_file:
      - .env
      - ./customAPI-gateway/.env.docker
    environment:
    - NOTIFICATION_SERVICE_URL=http://notification-service:4005
    - CHAT_SERVICE_URL=http://chat-service:4007
    - USER_SERVICE_URL=http://user-service:3009
    - COMPANY_SERVICE_URL=http://company-service:3001
    - JOB_SERVICE_URL=http://job-service:3002
    - APPLICATION_SERVICE_URL=http://application-service:3004
    - SUBSCRIPTION_SERVICE_URL=http://subscription-service:3005
    ports:
      - "4000:4000"
    depends_on:
      - user-service
      - company-service
      - job-service
      - subscription-service
      - application-service
      - notification-service
      - chat-service
    networks:
      - backend

# ==================== NETWORKS & VOLUMES ====================

networks:
  backend:
    driver: bridge

volumes:
  pg_data:
  redis_data:
